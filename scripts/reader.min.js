async function processFilters(){let e=$("#shuffleCheckbox").is(":checked"),t=$("#oneContextSentenceCheckbox").is(":checked"),n=$("#highlightVocabCheckbox").is(":checked"),a=$("#beginLevelTextBox").val(),r=$("#endLevelTextBox").val(),o=$("#numOfSentencesPerParagraphTextBox").val(),i=$("#fontSizeDropdown").val();$("#spinner").show(),$("#mainContent").empty();let l=getApiToken(),s=await getUserData(l),c=s.level,g=await getVocabularyData(l,c),h=getSentences(g,t,a,r);adjustLevelFiltersIfNeeded(a,r,c),displaySentencesOnPage(h,e,n,o,i),$(".popover-dismiss").popover({trigger:"focus"}),$('[data-toggle="popover"]').popover(),$("#spinner").hide(),saveFilterPrefs()}function saveFilterPrefs(){let e=$("#shuffleCheckbox").is(":checked"),t=$("#oneContextSentenceCheckbox").is(":checked"),n=$("#highlightVocabCheckbox").is(":checked"),a=$("#beginLevelTextBox").val(),r=$("#endLevelTextBox").val(),o=$("#numOfSentencesPerParagraphTextBox").val(),i=$("#fontSizeDropdown").val(),l="WaniKaniReaderPreferences",s=e+","+t+","+n+","+a+","+r+","+o+","+i;localStorage.setItem(l,s)}function loadFilterPrefs(){let e="WaniKaniReaderPreferences";if(!localStorage.getItem(e))return;let t=localStorage.getItem(e),n=t.split(",");$("#shuffleCheckbox").prop("checked","true"===n[0]),$("#oneContextSentenceCheckbox").prop("checked","true"===n[1]),$("#highlightVocabCheckbox").prop("checked","true"===n[2]),$("#beginLevelTextBox").val(n[3]),$("#endLevelTextBox").val(n[4]),$("#numOfSentencesPerParagraphTextBox").val(n[5]),$("#fontSizeDropdown").val(n[6])}function adjustLevelFiltersIfNeeded(e,t,n){e>n&&$("#beginLevelTextBox").val(n),t>n&&$("#endLevelTextBox").val(n)}function getApiToken(){let e="WaniKaniUserToken";return localStorage.getItem(e)}async function getUserData(e,t=1){let n="WaniKaniUserData",a=new Headers({"Wanikani-Revision":"20170710",Authorization:"Bearer "+e});if(sessionStorage.getItem(n))return Promise.resolve(JSON.parse(sessionStorage.getItem(n)));{let e=new Request("https://api.wanikani.com/v2/user",{method:"GET",headers:a});return fetch(e).then(e=>e.json()).then(e=>(sessionStorage.setItem(n,JSON.stringify(e.data)),e.data))}}async function getVocabularyData(e,t){let n=getLevels(t),a="subjects?types=vocabulary&levels="+n,r=!0,o=[],i=new Headers({"Wanikani-Revision":"20170710",Authorization:"Bearer "+e}),l="https://api.wanikani.com/v2/"+a;for(;r;){let e=new Request(l,{method:"GET",headers:i}),t=await fetch(e).then(e=>e.json()).then(e=>e);t.data.forEach(e=>{var t={};t.level=e.data.level,t.characters=e.data.characters,t.context_sentences=e.data.context_sentences,t.meaning=getMeanings(e.data.meanings),t.reading=getReadings(e.data.readings),o.push(t)}),t.pages.next_url?l=t.pages.next_url:r=!1}return Promise.resolve(o)}function getMeanings(e){let t=e.map(e=>e.meaning);return t.join(", ")}function getReadings(e){let t=e.map(e=>e.reading);return t.join(" or ")}function displaySentencesOnPage(e,t,n,a,r){let o=t?shuffleArray(e):e.sort((e,t)=>e.level>t.level?1:-1),i=getSentencesForDisplay(o,n),l=$("#mainContent"),s=a,c="";i.forEach(e=>{0===s?(l.append("<p>"+c+"</p>"),s=a,c=""):(c+=e,s--)}),l.css("font-size",r)}function getSentenceWithVocabHighlighted(e){let t=`<b>Level:</b> ${e.level}<br/>\n              <b>English Reading:</b> ${formatForHtml(e.meaning)}<br/>\n              <b>Japanese Reading:</b> ${formatForHtml(e.reading)}<br/>\n              <b>Sentence Reading:</b> ${formatForHtml(e.englishSentence)}<br/>\n              <b>Open In:</b> <a href="https://www.wanikani.com/vocabulary/${formatForHtml(e.vocabWord)}" target="_blank">WaniKani</a>\n  `,n="<span tabindex='0' data-trigger='focus' class='vocab-word' data-toggle='popover' data-html='true' container='body' data-content='"+t+"'>"+e.vocabWord+"</span>",a=e.japaneseSentence.replace(e.vocabWord,n);return a}function formatForHtml(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/</g,"&lt;"),e=e.replace(/"/g,"&quot;"),e=e.replace(/'/g,"&#039;"),e}function getSentences(e,t,n,a){let r=[];return e.forEach(e=>{let o=e.level;if(o<n||o>a)return;let i=e.context_sentences;for(let n=0;n<i.length;n++){let a=e.level,o=e.characters,l=e.meaning,s=e.reading,c="",g="";if(t){let e=Math.floor(Math.random()*i.length);c=i[e].ja,g=i[e].en}else c=i[n].ja,g=i[n].en;if(r.push({level:a,vocabWord:o,meaning:l,reading:s,japaneseSentence:c,englishSentence:g}),t)break}}),r}function getSentencesForDisplay(e,t){let n=[];return e.forEach(e=>{let a=t?getSentenceWithVocabHighlighted(e):e.japaneseSentence;n.push(a)}),n}function shuffleArray(e){let t=e.slice(0);for(var n=t.length-1;n>0;n--){var a=Math.floor(Math.random()*(n+1)),r=t[n];t[n]=t[a],t[a]=r}return t}function getLevels(e){for(var t=[],n=1;n<=e;n++)t.push(n);return t.join(",")}$(function(){let e=getApiToken();null==e&&(window.location.href="enter-token.html?returnUrl=reader.html"),$("#spinner").hide(),loadFilterPrefs()});